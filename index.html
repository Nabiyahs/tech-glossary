


<div class="tech-glossary">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
        .tech-glossary {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            line-height: 1.6;
        }

        .tech-glossary * {
            box-sizing: border-box;
        }

        .tech-glossary .glossary-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #0047AB;
            padding-bottom: 20px;
        }

        .tech-glossary .glossary-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0047AB;
            margin-bottom: 10px;
            margin-top: 0;
        }

        .tech-glossary .glossary-subtitle {
            font-size: 1.5rem;
            color: #666;
            font-weight: 500;
            margin: 0;
        }

        .tech-glossary .disclaimer-box {
            background: #f8f9fa;
            border-left: 4px solid #0047AB;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .tech-glossary .disclaimer-box p {
            margin: 0 0 10px 0;
        }

        .tech-glossary .disclaimer-box p:last-child {
            margin-bottom: 0;
        }

    .tech-glossary {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px; margin: 0 auto; padding: 20px; background: #fff; line-height: 1.6;
    }
    .tech-glossary * { box-sizing: border-box; }
    .glossary-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #0047AB; padding-bottom: 20px; }
    .glossary-title { font-size: 2rem; font-weight: 800; color: #0047AB; margin: 0 0 6px 0; }
    .glossary-subtitle { font-size: 1.1rem; color: #666; font-weight: 600; margin: 0; }

    .disclaimer-box { background: #f8f9fa; border-left: 4px solid #0047AB; padding: 16px; margin-bottom: 20px; border-radius: 6px; }
    .disclaimer-box p { margin: 0; }

    .search-add-section { display: flex; gap: 12px; align-items: center; margin-bottom: 14px; }
    .search-input { flex: 1; padding: 12px 16px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    .search-input:focus { border-color: #0047AB; outline: none; box-shadow: 0 0 0 3px rgba(0,71,171,.1); }

    .controls-section { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    .view-controls { display: flex; gap: 8px; }
    .view-btn { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #ddd; background: #fff; color: #333; border-radius: 8px; cursor: pointer; transition: all .2s; font-size: 14px; font-weight: 600; }
    .view-btn:hover { border-color: #0047AB; color: #0047AB; }
    .view-btn.active { background: #0047AB; color: #fff; border-color: #0047AB; }

    .disciplines-section { margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px; }
    .discipline-tag { padding: 7px 12px; background: #e9ecef; border: 1px solid #ddd; border-radius: 18px; cursor: pointer; transition: all .2s; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .discipline-tag:hover { background: #dee2e6; }
    .discipline-tag.active { background: #0047AB; color: #fff; border-color: #0047AB; }
    .discipline-tag i { font-size: 14px; }

    .glossary-table-container { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .glossary-table { width: 100%; border-collapse: collapse; margin: 0; table-layout: fixed; }
    .glossary-table th { background: #f8f9fa; padding: 12px 8px; text-align: left; font-weight: 700; border-bottom: 2px solid #ddd; color: #333; position: sticky; top: 0; z-index: 1; }
    .glossary-table td { padding: 10px 8px; border-bottom: 1px solid #eee; vertical-align: top; word-break: break-word; }
    .glossary-table tr:hover { background: #f8f9fa; }
    .glossary-table tr:last-child td { border-bottom: none; }

    .discipline-badge { background: rgba(0,71,171,.1); color: #0047AB; padding: 3px 6px; border-radius: 4px; font-size: 12px; font-weight: 700; display: inline-block; }
    .term-en { font-weight: 700; color: #333; }
    .term-kr { font-weight: 700; color: #0047AB; }
    .empty-state { text-align: center; padding: 30px; color: #666; font-style: italic; }

    .header-sort-controls { display: flex; align-items: center; gap: 6px; font-weight: 700; }
    .header-sort-btn { background: none; border: none; cursor: pointer; padding: 2px 6px; font-size: 12px; color: #666; font-weight: 600; border-radius: 4px; transition: all .2s; white-space: nowrap; }
    .header-sort-btn:hover { background: #e9ecef; color: #333; }
    .header-sort-btn.active { background: #0047AB; color: #fff; }
    .header-divider { color: #ccc; font-size: 12px; }
    .dropdown-wrapper { position: relative; display: inline-block; }
    .dropdown-toggle { background: none; border: none; cursor: pointer; padding: 2px 4px; font-size: 11px; color: #666; transition: all .2s; }
    .dropdown-toggle:hover { color: #0047AB; }
    .dropdown-menu { position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,.15); min-width: 140px; z-index: 1000; display: none; margin-top: 4px; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; cursor: pointer; font-size: 13px; color: #333; transition: background .2s; }
    .dropdown-item:hover { background: #f0f4f8; }
    .dropdown-item.active { background: #0047AB; color: #fff; }
    .category-col { font-size: 12px; color: #495057; }
    .category-cell { display: inline-flex; align-items: center; gap: 4px; background: #f0f4f8; padding: 4px 8px; border-radius: 4px; font-weight: 600; white-space: nowrap; }
    .category-cell i { color: #0047AB; font-size: 11px; }

    .pagination-container { margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; gap: 14px; }
    .pagination-info { font-size: 13px; color: #6c757d; font-weight: 600; }
    .pagination-controls { display: flex; align-items: center; gap: 6px; }
    .pagination-btn { padding: 6px 10px; border: 1px solid #ddd; background: #fff; color: #495057; cursor: pointer; border-radius: 4px; font-size: 13px; font-weight: 600; transition: all .2s; min-width: 36px; height: 32px; display: flex; align-items: center; justify-content: center; }
    .pagination-btn:hover:not(:disabled) { background: #0047AB; color: #fff; border-color: #0047AB; }
    .pagination-btn:disabled { background: #f8f9fa; color: #adb5bd; cursor: not-allowed; border-color: #dee2e6; }
    .pagination-btn.active { background: #0047AB; color: #fff; border-color: #0047AB; }
    .pagination-pages { display: flex; gap: 4px; }
    .pagination-ellipsis { padding: 6px 4px; color: #6c757d; font-size: 13px; display: flex; align-items: center; }

    @media (max-width: 768px) {
      .tech-glossary { padding: 10px; }
      .glossary-title { font-size: 1.6rem; }
      .glossary-table th, .glossary-table td { padding: 8px 6px; font-size: 14px; }
      .glossary-table th:nth-child(5), .glossary-table td:nth-child(5) { display: none; }
      .pagination-container { flex-direction: column; gap: 10px; text-align: center; }
      .pagination-controls { justify-content: center; flex-wrap: wrap; }
    }

    /* Confluence 자동 테이블 아이콘 숨기기 */
    .tech-glossary .tablesorter-header-inner .aui-icon,
    .tech-glossary .confluenceTh .aui-icon,
    .tech-glossary th .aui-icon,
    .tech-glossary .tableFloatingHeader .aui-icon,
    .tech-glossary .table-plus-btn,
    .tech-glossary .table-filter-btn,
    .tech-glossary [data-macro-name] .aui-icon,
    .tech-glossary .aui-iconfont-add,
    .tech-glossary .aui-iconfont-filter {
      display: none !important;
    }
  </style>

  <!-- Header -->
  <div class="glossary-header" role="region" aria-label="Technical Glossary Header">
    <h1 class="glossary-title">English-Korean Technical Glossary</h1>
    <div class="glossary-subtitle">한영 기술용어집</div>
  </div>

  <!-- Disclaimer -->
  <div class="disclaimer-box">
    <p><strong><i class="fa-solid fa-clipboard-list"></i> 안내사항:</strong> 이 용어집은 SAMOO 하이테크 1본부에서 해외 설계사 및 건설사와의 프로젝트 회의 통역 및 번역 업무를 통해 축적된 실무 용어집을 기반으로 작성되었습니다. 각 용어는 관련성과 실무 활용도에 따라 해당 공종으로 분류하였으며, 여러 공종에 공통으로 사용되는 용어의 경우 주요 적용 분야를 기준으로 배치하였습니다.</p>
    <p><strong><i class="fa-solid fa-envelope"></i> 문의:</strong> 하이테크 1본부 조희수 프로</p>
  </div>

  <!-- Search -->
  <div class="search-add-section" role="search">
    <input type="text" id="searchInput" class="search-input" placeholder="용어 검색 (영어, 한국어, 설명)..." aria-label="용어 검색 입력">
  </div>

  <!-- Controls -->
  <div class="controls-section" aria-label="보기 전환">
    <div class="view-controls" role="group" aria-label="보기 선택">
      <button class="view-btn active" id="disciplineViewBtn" type="button">
        <i class="fa-solid fa-layer-group"></i>
        공종별 보기
      </button>
      <button class="view-btn" id="allViewBtn" type="button">
        <i class="fa-solid fa-list"></i>
        전체 보기
      </button>
    </div>
  </div>

  <!-- Discipline Shortcuts -->
  <div class="disciplines-section" id="disciplineShortcuts" role="navigation" aria-label="공종 선택"></div>

  <!-- Table -->
  <div class="glossary-table-container" role="region" aria-label="용어 테이블">
    <table class="glossary-table" id="glossaryTable">
      <thead>
      <tr>
        <th id="disciplineHeader" style="width:8%;display:none">구분</th>
        <th id="categoryHeader" style="width:14%">
          <div class="header-sort-controls">
            <button class="header-sort-btn" id="alphabetSortBtn" type="button" title="알파벳순 정렬">A-Z</button>
            <span class="header-divider">|</span>
            <button class="header-sort-btn active" id="categorySortBtn" type="button" title="분류순 정렬">분류</button>
            <div class="dropdown-wrapper">
              <button class="dropdown-toggle" id="categoryDropdownBtn" type="button" title="분류 필터"><i class="fa-solid fa-caret-down"></i></button>
              <div class="dropdown-menu" id="categoryDropdownMenu"></div>
            </div>
          </div>
        </th>
        <th style="width:27%">EN</th>
        <th style="width:21%">KR</th>
        <th style="width:30%">설명</th>
      </tr>
      </thead>
      <tbody id="glossaryTableBody"></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" id="paginationContainer" style="display:none" aria-label="페이지네이션">
    <div class="pagination-info"><span id="paginationInfo">전체 0개 용어</span></div>
    <div class="pagination-controls">
      <button class="pagination-btn" id="firstPageBtn" title="첫 페이지" type="button">«</button>
      <button class="pagination-btn" id="prevPageBtn" title="이전 페이지" type="button">‹</button>
      <div class="pagination-pages" id="paginationPages"></div>
      <button class="pagination-btn" id="nextPageBtn" title="다음 페이지" type="button">›</button>
      <button class="pagination-btn" id="lastPageBtn" title="마지막 페이지" type="button">»</button>
    </div>
  </div>
</div>

<script>
/* ===========================================
   0) 헬퍼 함수 - 퍼지 검색 및 대문자 처리
   =========================================== */

// Levenshtein 거리 계산 함수 (오타 허용 검색용)
function levenshteinDistance(str1, str2) {
  const m = str1.length;
  const n = str2.length;
  const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

  for (let i = 0; i <= m; i++) dp[i][0] = i;
  for (let j = 0; j <= n; j++) dp[0][j] = j;

  for (let i = 1; i <= m; i++) {
    for (let j = 1; j <= n; j++) {
      if (str1[i - 1] === str2[j - 1]) {
        dp[i][j] = dp[i - 1][j - 1];
      } else {
        dp[i][j] = Math.min(dp[i - 1][j - 1], dp[i - 1][j], dp[i][j - 1]) + 1;
      }
    }
  }
  return dp[m][n];
}

// 퍼지 매칭 함수 - 검색어와 텍스트가 유사한지 확인
function fuzzyMatch(searchTerm, text) {
  if (!searchTerm || !text) return false;
  const search = searchTerm.toLowerCase();
  const target = text.toLowerCase();

  // 정확히 포함하면 true
  if (target.includes(search)) return true;

  // 단어별로 분리하여 검색
  const words = target.split(/[\s,\/\-\(\)]+/).filter(w => w.length > 0);

  for (const word of words) {
    // 검색어가 2글자 이하면 거리 1까지 허용
    // 검색어가 3-4글자면 거리 1까지 허용
    // 검색어가 5글자 이상이면 거리 2까지 허용
    const maxDistance = search.length <= 4 ? 1 : 2;

    // 단어 길이가 비슷할 때만 퍼지 검색 적용 (길이 차이가 크면 스킵)
    if (Math.abs(word.length - search.length) <= maxDistance) {
      const distance = levenshteinDistance(search, word);
      if (distance <= maxDistance) return true;
    }

    // 부분 문자열 퍼지 검색 (긴 단어 내에서)
    if (word.length >= search.length) {
      for (let i = 0; i <= word.length - search.length; i++) {
        const substr = word.substring(i, i + search.length);
        const distance = levenshteinDistance(search, substr);
        if (distance <= 1) return true;
      }
    }
  }

  return false;
}

// 영어 대문자 처리 함수 - 첫 글자 및 (, /, - 다음 글자 대문자
function formatEnglishTerm(text) {
  if (!text) return '';

  let result = '';
  let capitalizeNext = true;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];

    if (capitalizeNext && /[a-zA-Z]/.test(char)) {
      result += char.toUpperCase();
      capitalizeNext = false;
    } else {
      result += char;
    }

    // (, /, - 다음 글자는 대문자로
    if (char === '(' || char === '/' || char === '-') {
      capitalizeNext = true;
    }
  }

  return result;
}

/* ===========================================
   1) 전역 변수 초기화
   =========================================== */
let glossaryData = [];
let currentView = 'discipline';
let selectedDiscipline = 'General';
let currentPage = 1;
const itemsPerPage = 50;
let filteredDataGlobal = [];

// Confluence 페이지 ID
const PAGE_ID = '56625515';

// 공종별 JSON 파일 매핑
const jsonFiles = {
  'General': 'general.json',
  'Architecture': 'architecture.json',
  'Civil': ['civil-1.json', 'civil-2.json', 'civil-3.json', 'civil-4.json'],
  'Structure': 'structure.json',
  'Fire Protection': 'fire-protection.json',
  'Piping': 'piping.json',
  'Electrical': 'electrical.json',
  'Instrument & Control': 'instrument-and-control.json',
  'HVAC': 'hvac.json',
  'BIM': 'bim.json',
  'Cell': 'cell.json'
};

async function loadGlossaryData() {
  const allData = [];

  // REST API로 첨부파일 목록 가져오기
  let attachmentMap = {};
  try {
    const response = await fetch('/rest/api/content/' + PAGE_ID + '/child/attachment?expand=download&limit=50');
    if (response.ok) {
      const result = await response.json();
      result.results.forEach(att => {
        attachmentMap[att.title] = att._links.download;
      });
    }
  } catch (error) {
    console.warn('Failed to fetch attachment list:', error.message);
  }

  const loadPromises = [];
  for (const [discipline, files] of Object.entries(jsonFiles)) {
    const fileList = Array.isArray(files) ? files : [files];
    for (const filename of fileList) {
      const downloadPath = attachmentMap[filename];
      if (!downloadPath) {
        console.warn('Attachment not found: ' + filename);
        continue;
      }
      loadPromises.push(
        fetch(downloadPath)
          .then(response => {
            if (!response.ok) throw new Error('Failed to load ' + filename);
            return response.json();
          })
          .catch(error => {
            console.warn('Failed to load ' + discipline + ' (' + filename + '):', error.message);
            return [];
          })
      );
    }
  }

  const results = await Promise.all(loadPromises);
  results.forEach(data => allData.push(...data));
  return allData;
}

const disciplineMap = {
  'General': { abbreviation: 'Gen', koreanName: '일반', icon: 'fa-solid fa-file-lines' },
  'Architecture': { abbreviation: 'Arch', koreanName: '건축', icon: 'fa-solid fa-building' },
  'Electrical': { abbreviation: 'Elec', koreanName: '전기', icon: 'fa-solid fa-bolt' },
  'Piping': { abbreviation: 'Piping', koreanName: '배관', icon: 'fa-solid fa-wrench' },
  'Civil': { abbreviation: 'Civil', koreanName: '토목', icon: 'fa-solid fa-mountain' },
  'Instrument & Control': { abbreviation: 'I&C', koreanName: '제어', icon: 'fa-solid fa-gauge-high' },
  'Fire Protection': { abbreviation: 'FP', koreanName: '소방', icon: 'fa-solid fa-fire-extinguisher' },
  'HVAC': { abbreviation: 'HVAC', koreanName: '공조', icon: 'fa-solid fa-fan' },
  'Structure': { abbreviation: 'Struct', koreanName: '구조', icon: 'fa-solid fa-border-all' },
  'Cell': { abbreviation: 'Cell', koreanName: '배터리', icon: 'fa-solid fa-car-battery' },
  'BIM': { abbreviation: 'BIM', koreanName: 'BIM', icon: 'fa-solid fa-cubes' }
};
const disciplineOrder = ['General','Architecture','Civil','Structure','Fire Protection','Piping','Electrical','Instrument & Control','HVAC','BIM','Cell'];

/* ===========================================
   2-1) 연관성 카테고리 매핑
   =========================================== */
const categoryMap = {
  'Architecture': {
    '도면/문서': {
      icon: 'fa-solid fa-drafting-compass',
      order: 1,
      keywords: ['drawing', 'plan', 'section', 'elevation', 'detail', 'view', 'diagram', 'layout', 'scale', 'perspective', 'isometric', 'document', 'sheet', 'index', 'schedule']
    },
    '문/출입구': {
      icon: 'fa-solid fa-door-open',
      order: 2,
      keywords: ['door', 'gate', 'turnstile', 'entrance', 'doorway', 'opening', 'leaf', 'frame', 'handle', 'knob', 'latch', 'swing', 'hinged', 'sliding', 'revolving', 'overhead', 'folding']
    },
    '계단/동선': {
      icon: 'fa-solid fa-stairs',
      order: 3,
      keywords: ['stair', 'step', 'riser', 'tread', 'landing', 'ramp', 'circulation', 'corridor', 'aisle', 'walkway', 'passage', 'path', 'route', 'handrail', 'guard', 'railing']
    },
    '피난/안전': {
      icon: 'fa-solid fa-person-running',
      order: 4,
      keywords: ['egress', 'exit', 'refuge', 'evacuation', 'emergency', 'alarm', 'fire', 'smoke', 'sprinkler', 'extinguish', 'detection', 'standpipe', 'hazard', 'protection', 'safety', 'combustible', 'flammable']
    },
    '면적/치수': {
      icon: 'fa-solid fa-ruler-combined',
      order: 5,
      keywords: ['area', 'height', 'width', 'depth', 'distance', 'clearance', 'footage', 'volume', 'capacity', 'load', 'occupant', 'size', 'measurement', 'dimension', 'stories', 'grade']
    },
    '공간/실': {
      icon: 'fa-solid fa-cube',
      order: 6,
      keywords: ['room', 'space', 'zone', 'basement', 'attic', 'mezzanine', 'lobby', 'vestibule', 'closet', 'shaft', 'enclosure', 'compartment', 'penthouse', 'platform']
    },
    '벽/바닥/천장': {
      icon: 'fa-solid fa-layer-group',
      order: 7,
      keywords: ['wall', 'partition', 'floor', 'ceiling', 'roof', 'panel', 'drywall', 'gypsum', 'tile', 'covering', 'finish', 'membrane', 'insulation', 'baseboard', 'siding']
    },
    '창/유리': {
      icon: 'fa-solid fa-window-maximize',
      order: 8,
      keywords: ['window', 'glass', 'glazing', 'skylight', 'transom', 'louver', 'tempered', 'laminated', 'vision']
    },
    '법규/인허가': {
      icon: 'fa-solid fa-gavel',
      order: 9,
      keywords: ['code', 'approval', 'permit', 'certificate', 'occupancy', 'zoning', 'classification', 'requirement', 'compliance', 'rating', 'allowable', 'exception', 'regulation']
    },
    '지붕': {
      icon: 'fa-solid fa-house-chimney',
      order: 10,
      keywords: ['roof', 'eave', 'ridge', 'gable', 'hip', 'mansard', 'gambrel', 'dormer', 'pitch', 'parapet', 'flashing', 'curb']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'General': {
    '프로젝트/계약': {
      icon: 'fa-solid fa-file-contract',
      order: 1,
      keywords: ['project', 'contract', 'client', 'contractor', 'subcontract', 'delivery', 'rfp', 'rfq', 'rfi', 'bid', 'award', 'procurement']
    },
    '설계': {
      icon: 'fa-solid fa-compass-drafting',
      order: 2,
      keywords: ['design', 'engineering', 'drawing', 'plan', 'detail', 'specification', 'parameter']
    },
    '시공/공사': {
      icon: 'fa-solid fa-helmet-safety',
      order: 3,
      keywords: ['construction', 'install', 'work', 'fastener', 'mounting', 'assembly']
    },
    '품질/안전': {
      icon: 'fa-solid fa-shield-check',
      order: 4,
      keywords: ['quality', 'safety', 'test', 'inspection', 'resistance', 'protection']
    },
    '재료': {
      icon: 'fa-solid fa-cubes',
      order: 5,
      keywords: ['steel', 'metal', 'iron', 'paint', 'coat', 'rubber', 'resin', 'material', 'zinc', 'galvaniz']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Civil': {
    '도로/포장': {
      icon: 'fa-solid fa-road',
      order: 1,
      keywords: ['road', 'pave', 'asphalt', 'concrete', 'curb', 'gutter', 'sidewalk', 'lane', 'traffic']
    },
    '배수/우수': {
      icon: 'fa-solid fa-droplet',
      order: 2,
      keywords: ['drain', 'storm', 'water', 'sewer', 'pipe', 'culvert', 'catch', 'basin', 'manhole']
    },
    '토공/기초': {
      icon: 'fa-solid fa-mountain-sun',
      order: 3,
      keywords: ['earth', 'excavat', 'fill', 'grade', 'slope', 'soil', 'compact', 'foundation', 'retaining']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Structure': {
    '기둥/보': {
      icon: 'fa-solid fa-table-columns',
      order: 1,
      keywords: ['column', 'beam', 'girder', 'member', 'frame']
    },
    '바닥/슬래브': {
      icon: 'fa-solid fa-square',
      order: 2,
      keywords: ['slab', 'floor', 'deck', 'topping']
    },
    '철근/콘크리트': {
      icon: 'fa-solid fa-cubes-stacked',
      order: 3,
      keywords: ['concrete', 'rebar', 'reinforc', 'steel', 'bar', 'stirrup', 'anchor']
    },
    '접합': {
      icon: 'fa-solid fa-link',
      order: 4,
      keywords: ['connect', 'joint', 'weld', 'bolt', 'splice', 'embed']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Electrical': {
    '배선/케이블': {
      icon: 'fa-solid fa-plug',
      order: 1,
      keywords: ['cable', 'wire', 'conduit', 'tray', 'raceway', 'duct', 'conductor']
    },
    '배전반/분전반': {
      icon: 'fa-solid fa-server',
      order: 2,
      keywords: ['panel', 'board', 'switch', 'breaker', 'bus', 'mcc', 'distribution']
    },
    '조명': {
      icon: 'fa-solid fa-lightbulb',
      order: 3,
      keywords: ['light', 'lamp', 'fixture', 'luminaire', 'illuminat']
    },
    '접지/피뢰': {
      icon: 'fa-solid fa-bolt',
      order: 4,
      keywords: ['ground', 'earth', 'lightning', 'surge', 'protection']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Piping': {
    '배관': {
      icon: 'fa-solid fa-grip-lines',
      order: 1,
      keywords: ['pipe', 'tube', 'line', 'piping', 'fitting', 'flange', 'elbow', 'tee', 'reducer']
    },
    '밸브': {
      icon: 'fa-solid fa-sliders',
      order: 2,
      keywords: ['valve', 'gate', 'globe', 'check', 'ball', 'butterfly', 'control']
    },
    '펌프/탱크': {
      icon: 'fa-solid fa-gas-pump',
      order: 3,
      keywords: ['pump', 'tank', 'vessel', 'reservoir']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'HVAC': {
    '덕트': {
      icon: 'fa-solid fa-wind',
      order: 1,
      keywords: ['duct', 'damper', 'diffuser', 'grille', 'louver', 'plenum']
    },
    '공조기기': {
      icon: 'fa-solid fa-fan',
      order: 2,
      keywords: ['ahu', 'fcu', 'unit', 'coil', 'fan', 'blower', 'compressor', 'chiller', 'boiler']
    },
    '냉난방': {
      icon: 'fa-solid fa-temperature-half',
      order: 3,
      keywords: ['cool', 'heat', 'temperature', 'refriger', 'thermal']
    },
    '환기': {
      icon: 'fa-solid fa-arrows-rotate',
      order: 4,
      keywords: ['ventilat', 'exhaust', 'supply', 'air', 'fresh', 'return']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Fire Protection': {
    '스프링클러': {
      icon: 'fa-solid fa-shower',
      order: 1,
      keywords: ['sprinkler', 'head', 'pipe', 'riser', 'standpipe']
    },
    '소화설비': {
      icon: 'fa-solid fa-fire-extinguisher',
      order: 2,
      keywords: ['extinguish', 'suppression', 'foam', 'gas', 'halon', 'co2', 'chemical']
    },
    '경보/감지': {
      icon: 'fa-solid fa-bell',
      order: 3,
      keywords: ['alarm', 'detector', 'sensor', 'smoke', 'heat', 'notification']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Instrument & Control': {
    '계기': {
      icon: 'fa-solid fa-gauge',
      order: 1,
      keywords: ['gauge', 'meter', 'indicator', 'transmitter', 'sensor']
    },
    '제어': {
      icon: 'fa-solid fa-sliders',
      order: 2,
      keywords: ['control', 'plc', 'dcs', 'hmi', 'scada', 'logic']
    },
    '밸브/액추에이터': {
      icon: 'fa-solid fa-cog',
      order: 3,
      keywords: ['valve', 'actuator', 'positioner', 'solenoid']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'BIM': {
    '모델링': {
      icon: 'fa-solid fa-cube',
      order: 1,
      keywords: ['model', 'geometry', 'object', 'element', 'component', 'family', 'library']
    },
    '좌표/기준': {
      icon: 'fa-solid fa-crosshairs',
      order: 2,
      keywords: ['coordinate', 'point', 'base', 'survey', 'level', 'grid']
    },
    '품질검토': {
      icon: 'fa-solid fa-check-double',
      order: 3,
      keywords: ['clash', 'quality', 'review', 'check', 'validation']
    },
    '데이터/속성': {
      icon: 'fa-solid fa-database',
      order: 4,
      keywords: ['data', 'parameter', 'property', 'attribute', 'information', 'lod']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  },
  'Cell': {
    '배터리': {
      icon: 'fa-solid fa-battery-full',
      order: 1,
      keywords: ['battery', 'cell', 'module', 'pack', 'bms']
    },
    '전극/소재': {
      icon: 'fa-solid fa-atom',
      order: 2,
      keywords: ['electrode', 'cathode', 'anode', 'electrolyte', 'separator', 'material']
    },
    '일반': {
      icon: 'fa-solid fa-folder',
      order: 99,
      keywords: []
    }
  }
};

// 용어에 카테고리 할당 함수
function assignCategory(term) {
  const discipline = term.discipline;
  const categories = categoryMap[discipline];
  if (!categories) return '일반';

  const searchText = ((term.en || '') + ' ' + (term.kr || '') + ' ' + (term.description || '')).toLowerCase();

  let bestMatch = '일반';
  let bestOrder = 999;

  for (const [catName, catInfo] of Object.entries(categories)) {
    if (catName === '일반') continue;
    for (const keyword of catInfo.keywords) {
      if (searchText.includes(keyword.toLowerCase())) {
        if (catInfo.order < bestOrder) {
          bestMatch = catName;
          bestOrder = catInfo.order;
        }
        break;
      }
    }
  }
  return bestMatch;
}

// 현재 정렬 모드 (alphabet-asc / alphabet-desc / relevance) - 기본값: relevance
let currentSortMode = 'relevance';
// 알파벳 정렬 방향 (asc / desc)
let alphabetSortDirection = 'asc';
// 카테고리 필터 (null = 전체)
let selectedCategoryFilter = null;

/* ===========================================
   3) 초기화
   =========================================== */
async function initializeGlossary() {
  // 로딩 표시
  const tbody = document.getElementById('glossaryTableBody');
  if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:#666;">데이터 로딩 중...</td></tr>';

  // JSON 데이터 로드
  glossaryData = await loadGlossaryData();
  console.log('Loaded ' + glossaryData.length + ' terms');

  renderDisciplineShortcuts();
  setupEventListeners();
  renderTable();
}

(function safelyInit() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGlossary, { once: true });
  } else {
    initializeGlossary();
  }
})();

/* ===========================================
   4) 이벤트
   =========================================== */
function setupEventListeners() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) searchInput.addEventListener('input', handleSearch);

  const disciplineBtn = document.getElementById('disciplineViewBtn');
  const allBtn = document.getElementById('allViewBtn');
  if (disciplineBtn) disciplineBtn.addEventListener('click', () => setView('discipline'));
  if (allBtn) allBtn.addEventListener('click', () => setView('all'));

  // 헤더 정렬 버튼
  const alphabetBtn = document.getElementById('alphabetSortBtn');
  const categoryBtn = document.getElementById('categorySortBtn');
  if (alphabetBtn) alphabetBtn.addEventListener('click', toggleAlphabetSort);
  if (categoryBtn) categoryBtn.addEventListener('click', () => setSortMode('relevance'));

  // 드롭다운 메뉴
  const dropdownBtn = document.getElementById('categoryDropdownBtn');
  if (dropdownBtn) dropdownBtn.addEventListener('click', toggleDropdown);

  // 드롭다운 외부 클릭 시 닫기
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('categoryDropdownMenu');
    const btn = document.getElementById('categoryDropdownBtn');
    if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
      dropdown.classList.remove('show');
    }
  });

  const firstBtn = document.getElementById('firstPageBtn');
  const prevBtn  = document.getElementById('prevPageBtn');
  const nextBtn  = document.getElementById('nextPageBtn');
  const lastBtn  = document.getElementById('lastPageBtn');
  if (firstBtn) firstBtn.addEventListener('click', () => goToPage(1));
  if (prevBtn)  prevBtn.addEventListener('click', () => goToPage(currentPage - 1));
  if (nextBtn)  nextBtn.addEventListener('click', () => goToPage(currentPage + 1));
  if (lastBtn)  lastBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredDataGlobal.length / itemsPerPage) || 1;
    goToPage(totalPages);
  });
}

function setSortMode(mode) {
  currentSortMode = mode;
  updateSortButtons();
  currentPage = 1;
  renderTable(document.getElementById('searchInput').value || '');
}

function toggleAlphabetSort() {
  if (currentSortMode === 'alphabet') {
    // 이미 알파벳 모드면 방향 토글
    alphabetSortDirection = alphabetSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortMode = 'alphabet';
    alphabetSortDirection = 'asc';
  }
  updateSortButtons();
  currentPage = 1;
  renderTable(document.getElementById('searchInput').value || '');
}

function updateSortButtons() {
  const alphabetBtn = document.getElementById('alphabetSortBtn');
  const categoryBtn = document.getElementById('categorySortBtn');
  if (alphabetBtn) {
    alphabetBtn.classList.toggle('active', currentSortMode === 'alphabet');
    alphabetBtn.textContent = currentSortMode === 'alphabet'
      ? (alphabetSortDirection === 'asc' ? 'A-Z' : 'Z-A')
      : 'A-Z';
  }
  if (categoryBtn) {
    categoryBtn.classList.toggle('active', currentSortMode === 'relevance');
  }
}

function toggleDropdown(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('categoryDropdownMenu');
  if (dropdown) {
    dropdown.classList.toggle('show');
    if (dropdown.classList.contains('show')) {
      renderCategoryDropdown();
    }
  }
}

function renderCategoryDropdown() {
  const dropdown = document.getElementById('categoryDropdownMenu');
  if (!dropdown) return;

  // 현재 공종의 카테고리 목록 가져오기
  const discipline = currentView === 'discipline' ? selectedDiscipline : null;
  const categories = discipline && categoryMap[discipline] ? Object.keys(categoryMap[discipline]) : [];

  dropdown.innerHTML = '';

  // 전체 옵션
  const allItem = document.createElement('button');
  allItem.type = 'button';
  allItem.className = 'dropdown-item' + (selectedCategoryFilter === null ? ' active' : '');
  allItem.textContent = '전체';
  allItem.addEventListener('click', () => selectCategoryFilter(null));
  dropdown.appendChild(allItem);

  // 카테고리별 옵션
  if (categories.length > 0) {
    categories.sort((a, b) => {
      const orderA = categoryMap[discipline][a]?.order || 99;
      const orderB = categoryMap[discipline][b]?.order || 99;
      return orderA - orderB;
    });
    categories.forEach(cat => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'dropdown-item' + (selectedCategoryFilter === cat ? ' active' : '');
      item.textContent = cat;
      item.addEventListener('click', () => selectCategoryFilter(cat));
      dropdown.appendChild(item);
    });
  }
}

function selectCategoryFilter(category) {
  selectedCategoryFilter = category;
  const dropdown = document.getElementById('categoryDropdownMenu');
  if (dropdown) dropdown.classList.remove('show');
  currentPage = 1;
  renderTable(document.getElementById('searchInput').value || '');
}

/* ===========================================
   5) 핸들러 / 렌더링
   =========================================== */
function handleSearch(e) {
  const val = (e.target.value || '').toLowerCase();
  currentPage = 1;
  renderTable(val);
}

function setView(view) {
  currentView = view;
  selectedCategoryFilter = null; // 뷰 변경 시 카테고리 필터 초기화
  document.getElementById('disciplineViewBtn').classList.toggle('active', view === 'discipline');
  document.getElementById('allViewBtn').classList.toggle('active', view === 'all');
  document.getElementById('disciplineHeader').style.display = (view === 'discipline') ? 'none' : 'table-cell';
  currentPage = 1;
  renderTable(document.getElementById('searchInput').value || '');
}

function renderDisciplineShortcuts() {
  const container = document.getElementById('disciplineShortcuts');
  if (!container) return;
  container.innerHTML = '';
  disciplineOrder.forEach(discipline => {
    const info = disciplineMap[discipline] || {};
    const el = document.createElement('button');
    el.type = 'button';
    el.className = 'discipline-tag' + (discipline === selectedDiscipline ? ' active' : '');
    el.innerHTML = '<i class="' + (info.icon || 'fa-solid fa-folder') + '"></i> ' + (info.koreanName || discipline);
    el.addEventListener('click', () => {
      selectedDiscipline = discipline;
      selectedCategoryFilter = null; // 공종 변경 시 카테고리 필터 초기화
      renderDisciplineShortcuts();
      if (currentView === 'discipline') { currentPage = 1; renderTable(document.getElementById('searchInput').value || ''); }
    });
    container.appendChild(el);
  });
}

function renderTable(searchTerm = '') {
  const tbody = document.getElementById('glossaryTableBody');
  if (!tbody) return;

  let filtered = glossaryData.slice();
  if (searchTerm) {
    filtered = filtered.filter(t =>
      fuzzyMatch(searchTerm, t.en || '') ||
      fuzzyMatch(searchTerm, t.kr || '') ||
      fuzzyMatch(searchTerm, t.description || '') ||
      fuzzyMatch(searchTerm, disciplineMap[t.discipline]?.abbreviation || '') ||
      fuzzyMatch(searchTerm, disciplineMap[t.discipline]?.koreanName || '')
    );
  }
  if (currentView === 'discipline') {
    filtered = filtered.filter(t => t.discipline === selectedDiscipline);
  }

  // 모든 용어에 카테고리 할당 (Category 열 표시를 위해)
  filtered.forEach(t => {
    t._category = assignCategory(t);
  });

  // 카테고리 필터 적용 (공종별 보기에서만)
  if (currentView === 'discipline' && selectedCategoryFilter) {
    filtered = filtered.filter(t => t._category === selectedCategoryFilter);
  }

  // 연관성 정렬 모드
  if (currentSortMode === 'relevance') {
    // 카테고리 순서 및 알파벳순 정렬
    filtered.sort((a, b) => {
      if (currentView === 'all') {
        const ai = disciplineOrder.indexOf(a.discipline);
        const bi = disciplineOrder.indexOf(b.discipline);
        if (ai !== bi) return ai - bi;
      }

      const catMapA = categoryMap[a.discipline] || {};
      const catMapB = categoryMap[b.discipline] || {};
      const catInfoA = catMapA[a._category] || { order: 99 };
      const catInfoB = catMapB[b._category] || { order: 99 };

      if (catInfoA.order !== catInfoB.order) {
        return catInfoA.order - catInfoB.order;
      }
      return a.en.localeCompare(b.en);
    });
  } else {
    // 알파벳순 정렬 (방향에 따라)
    const direction = alphabetSortDirection === 'asc' ? 1 : -1;
    filtered.sort((a, b) => {
      if (currentView === 'discipline') return direction * a.en.localeCompare(b.en);
      const ai = disciplineOrder.indexOf(a.discipline);
      const bi = disciplineOrder.indexOf(b.discipline);
      return ai !== bi ? ai - bi : direction * a.en.localeCompare(b.en);
    });
  }

  filteredDataGlobal = filtered;

  const total = filtered.length;
  const totalPages = Math.ceil(total / itemsPerPage) || 1;
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * itemsPerPage;
  const end   = Math.min(start + itemsPerPage, total);
  const pageData = filtered.slice(start, end);

  updatePaginationInfo(total, start, end);
  renderPaginationControls(totalPages);

  tbody.innerHTML = '';
  if (total === 0) {
    const row = tbody.insertRow();
    const cell = row.insertCell();
    cell.colSpan = (currentView === 'discipline') ? 4 : 5;
    cell.innerHTML = '<div class="empty-state">등록된 용어가 없습니다.</div>';
    document.getElementById('paginationContainer').style.display = 'none';
    return;
  }
  document.getElementById('paginationContainer').style.display = (total > itemsPerPage) ? 'flex' : 'none';

  pageData.forEach(t => {
    const row = tbody.insertRow();

    // 전체 보기일 때 구분 열 표시
    if (currentView === 'all') {
      const dcell = row.insertCell();
      const badge = (disciplineMap[t.discipline]?.abbreviation) || t.discipline;
      dcell.innerHTML = '<span class="discipline-badge">' + badge + '</span>';
    }

    // Category 열 추가
    const catCell = row.insertCell();
    const category = t._category || '일반';
    const catInfo = categoryMap[t.discipline]?.[category] || { icon: 'fa-solid fa-folder' };
    catCell.innerHTML = '<span class="category-cell"><i class="' + catInfo.icon + '"></i> ' + category + '</span>';
    catCell.className = 'category-col';

    const en = row.insertCell();
    en.textContent = formatEnglishTerm(t.en || '');
    en.className = 'term-en';

    const kr = row.insertCell();
    kr.textContent = t.kr || '';
    kr.className = 'term-kr';

    const desc = row.insertCell();
    desc.textContent = t.description || '';
  });
}

/* ===========================================
   6) 페이지네이션
   =========================================== */
function updatePaginationInfo(total, start, end) {
  const info = document.getElementById('paginationInfo');
  if (!info) return;
  info.textContent = total === 0 ? '전체 0개 용어' : '전체 ' + total + '개 용어 (' + (start + 1) + '-' + end + '번째 표시)';
}

function renderPaginationControls(totalPages) {
  const container = document.getElementById('paginationPages');
  const firstBtn = document.getElementById('firstPageBtn');
  const prevBtn  = document.getElementById('prevPageBtn');
  const nextBtn  = document.getElementById('nextPageBtn');
  const lastBtn  = document.getElementById('lastPageBtn');
  if (!container) return;

  container.innerHTML = '';
  firstBtn.disabled = currentPage === 1;
  prevBtn.disabled  = currentPage === 1;
  nextBtn.disabled  = currentPage === totalPages || totalPages === 0;
  lastBtn.disabled  = currentPage === totalPages || totalPages === 0;

  if (totalPages <= 1) return;

  const pages = generatePageNumbers(currentPage, totalPages);
  pages.forEach(p => {
    if (p === '...') {
      const span = document.createElement('span');
      span.className = 'pagination-ellipsis';
      span.textContent = '...';
      container.appendChild(span);
    } else {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'pagination-btn ' + (p === currentPage ? 'active' : '');
      btn.textContent = p;
      btn.addEventListener('click', () => goToPage(p));
      container.appendChild(btn);
    }
  });
}

function generatePageNumbers(current, total) {
  const pages = [];
  if (total <= 7) { for (let i = 1; i <= total; i++) pages.push(i); }
  else {
    pages.push(1);
    if (current <= 4) { for (let i = 2; i <= 5; i++) pages.push(i); pages.push('...', total); }
    else if (current >= total - 3) { pages.push('...'); for (let i = total - 4; i <= total; i++) pages.push(i); }
    else { pages.push('...', current - 1, current, current + 1, '...', total); }
  }
  return pages;
}

function goToPage(page) {
  const totalPages = Math.ceil((filteredDataGlobal.length || 0) / itemsPerPage) || 1;
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  renderTable(document.getElementById('searchInput').value || '');
}
</script>
